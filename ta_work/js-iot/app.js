function $(e){return document.getElementById(e)}var w,res_wifi=void 0,swSys=!0,swPWM=!0,swTerm=!1,swADC=!0,swMenu=!1,swZoom=!1,swCode=!1,swBlock=!1,swCV=!1,loop_selectIndex=0,loop_code_arr=[],block_selectIndex=0,block_code_arr=[],DATA,scanHandler;function $(e){return document.getElementById(e)}function swCodeStyle(){swCode?($("loop-code").innerHTML="方塊程式",$("loop-block-area").style.display="none",$("loop-tx").style.display="block",$("loop-swBlock").style.display="none",$("loop-swBlock").style.backgroundColor="hotpink",$("loop-codeView").style.display="none",$("loop-swBlock").innerHTML="顯示方塊",$("loop-codeView").innerHTML="預覽關閉",$("index-source-container").style.display="none",$("loop-codeView-result").style.display="none",$("block-selectCode").style.display="none",$("loop-selectCode").style.display=""):($("loop-code").innerText="JS 程式",$("loop-block-area").style.display="block",$("loop-tx").style.display="none",$("loop-swBlock").style.display="initial",$("loop-codeView").style.display="initial",$("loop-swBlock").innerHTML="隱藏方塊",$("loop-codeView").innerHTML="方塊JS預覽",$("loop-codeView").style.backgroundColor="#cdffee",$("index-source-container").style.display="block",$("block-selectCode").style.display="initial",$("loop-selectCode").style.display="none",swCV=!(swBlock=!0)),swCode=!swCode}function swBlocks(){swBlock?($("loop-swBlock").innerHTML="顯示方塊",$("loop-swBlock").style.backgroundColor="#cdffee",$("index-source-container").style.display="none"):($("loop-swBlock").innerHTML="隱藏方塊",$("loop-swBlock").style.backgroundColor="hotpink",$("index-source-container").style.display="block"),swBlock=!swBlock}function swCodeView(){swCV?($("loop-codeView").innerHTML="方塊js預覽",$("loop-codeView").style.backgroundColor="#cdffee",$("loop-block-area").style.display="block",$("loop-codeView-result").style.display="none"):($("loop-codeView").innerHTML="預覽關閉",$("loop-codeView").style.backgroundColor="hotpink",$("loop-block-area").style.display="none",$("loop-codeView-result").style.display="initial",$("loop-codeView-result").value=AllBlock2js()),swCV=!swCV}function Zoom(){swZoom?($("loop-edit").classList.remove("zoom-in"),$("loop-zoom").innerHTML="展開",$("loop-zoom").style.backgroundColor="#cdffee",$("loop-result").style="",window.scrollTo(100,document.body.scrollHeight)):($("loop-edit").classList.add("zoom-in"),$("loop-zoom").innerHTML="返回",$("loop-zoom").style.backgroundColor="hotpink",$("loop-result").style.display="none"),swZoom=!swZoom}function swSystem(){swSys?$("system").style.display="none":($("system").style.display="block",scroll({top:0,left:0,behavior:"smooth"})),swSys=!swSys}function swTerminal(){swTerm?($("terminal").style.display="none",$("loop").style.marginBottom="0px"):($("terminal").style.display="block",$("loop").style.marginBottom="450px"),swTerm=!swTerm}function swPWMstatus(){$("pwm").style.display=swPWM?"none":"block",swPWM=!swPWM}function swADCstatus(){$("adc").style.display=swADC?"none":"block",swADC=!swADC}function swMenuBar(){swMenu?($("open-term").style.display="none",$("open-sys").style.display="none",$("open-pwm").style.display="none",$("open-adc").style.display="none",$("open-export").style.display="none",$("open-upload").style.display="none",$("side-menu").children[0].innerHTML="選單"):($("open-term").style.display="block",$("open-sys").style.display="block",$("open-pwm").style.display="block",$("open-adc").style.display="block",$("open-export").style.display="block",$("open-upload").style.display="block",$("side-menu").children[0].innerHTML="收起"),swMenu=!swMenu}function showDataTable(e){$("table-data").innerHTML="";for(const a in e){var o,l,t,n;Object.hasOwnProperty.call(e,a)&&(o=e[a],l=document.createElement("tr"),t=document.createElement("td"),n=document.createElement("td"),t.innerHTML=a,l.appendChild(t),n.innerHTML=o,l.appendChild(n),$("table-data").appendChild(l))}}function showADC(l){try{for(let o=0;o<16;o++){let e=$(`adc-in-${o+1}`);e.innerHTML="-",e.innerHTML=l.adc[o]}}catch(e){console.error(e)}}function showPWM(l){try{for(let o=0;o<16;o++)if(o<8){let e=$(`pwm-out-${o+1}`);e.innerHTML="-",e.innerHTML=l.servo[o]}else{let e=$(`pwm-out-${o+1}`);e.innerHTML="-",e.innerHTML=l.pwm[o-8]}}catch(e){console.error(e)}}function clearMsg(){$("tx").value=""}function showWifi(){$("mask-wifi").style="display: block;",$("wifi-content").style="display: block",document.body.style.overflow="hidden",scanWifi()}function scanWifi(){var o=0,t="",n=$("wifi-result"),a=$("wifi-refresh");res_wifi="",n.innerHTML="",postCmd("@AP scan"),a.disabled=!0;var e=document.createElement("div"),l=document.createElement("h3");l.innerHTML="搜尋中...",e.appendChild(l),n.appendChild(e),scanHandler=setInterval(()=>{return 10<=(o+=1)?(alert("已逾時，請重新搜尋。"),clearInterval(scanHandler),n.innerHTML="",void(a.disabled=!1)):void(res_wifi&&(t=res_wifi,$("wifi-now").innerHTML=$("wifi").innerText,n.innerHTML="",e=t.split("|"),l=document.createElement("li"),n.appendChild(l),e.forEach(e=>{var o;""!==e&&((o=document.createElement("input")).className="w-btn",o.type="button",o.value=e,o.onclick=()=>inputWifiPWD(e),l.appendChild(o))}),clearInterval(scanHandler),a.disabled=!1));var e,l},1e3)}function closeWifi(){$("wifi-content").style="display: none",$("mask-wifi").style="display: none",$("wifi-list").style="display: block",document.body.style.overflow="",clearInterval(scanHandler)}function inputWifiPWD(e){var o=prompt(`SSID: ${e},Wifi密碼: `);null!==o&&(postCmd(`@AP connect [${e}]:[${o}]`),$("wifi-content").style="display: none",$("mask-wifi").style="display: none",$("wifi-list").style="display: block")}function resetWifi(){postCmd("@AP connect reset")}function reconnectWifi(){postCmd("@AP connect reconnect")}function switchWifi(e){"standalone"===e?($("wifi").innerText="獨立模式",$("wifi-now").innerText="獨立模式",$("wifi-mode").onclick=reconnectWifi,$("wifi-mode").innerText="重新連接",$("wifi-mode").title="重新連接最後一次連上的wifi"):($("wifi").innerText=e,$("wifi-now").innerText=e,$("wifi-mode").onclick=resetWifi,$("wifi-mode").innerText="切斷連接",$("wifi-mode").title="切斷wifi連接，切換為獨立模式")}function openHelp(){$("mask-help").style.display="block",$("help-content").style.display="block"}function closeHelp(){$("mask-help").style.display="none",$("help-content").style.display="none"}function setServo(e,o){postCmd(`set RC${e} ${o}`)}function setPWM(e,o){postCmd(`set CH${e} ${o}`)}function editDeviceName(e){postCmd(`@set Device ID: ${e}`)}function editBaud(e){postCmd(`@bps: ${e}`)}function editRemoteAddr(e){void 0!==e.split(":")[1]&&""!==e.split(":")[1]?postCmd(`set recv Addr ${e}`):postCmd(`set recv Addr ${e.split(":")[0]}:80`)}function getRemoteAddr(){postCmd("get recv Addr")}function getLocalIP(){postCmd(`send +ip REQ:ID:${$("device").innerText}`)}function connect(){"undefined"!=typeof Worker?(void 0===w&&((w=new Worker("./worker.js")).onmessage=wkMsg),cmd={URL:document.URL},w.postMessage(cmd)):console.log("not support Worker")}function wkMsg(o){try{if(o.data instanceof Uint8Array)return void(0===o.data[0]?showSYS(o.data):1===o.data[0]?showEEPROM(o.data):2===o.data[0]&&showUserData(o.data));var e;for(i in o.data)e=$(i),"tx"==i&&e?(e=$("tx"),str=e.value,str+="\n",str+=o.data[i],["ESP:set","ESP:SET"].some(e=>o.data[i].includes(e))&&alert("更換SSID成功，reset後生效"),"reconnected"===o.data[i]&&alert("已重新連上wifi!"),"reset"===o.data[i]&&alert("已切換至獨立模式!"),o.data[i].includes("set Device ID:")&&alert("已修改裝置名稱!"),o.data[i].includes("set Serial baudrate")&&alert("已修改裝置 UART Baud!"),o.data[i].includes("set correct baudrate")&&alert("請設定支援的Baud: 9600,19200,38400,74800,115200,230400"),o.data[i].includes("save")?(alert(`已設定遠端IP: ${o.data[i].split(" ")[1]}`),getRemoteAddr()):o.data[i].includes(":80")&&($("wifi-remote").innerText=`遠端IP ${o.data[i]}`),o.data[i].includes("file not exist")&&($("wifi-remote").innerText="遠端IP 未設定"),o.data[i].includes("IP:")&&($("wifi-local").innerText=`區網IP ${o.data[i].split(":")[1]}`),1e5<str.length&&(str=""),str.includes("|")&&(res_wifi=o.data.tx),e.value=str,e.scrollTop=e.scrollHeight):"content"===i?"no receive ip and port!!"===o.data[i]?alert("未設定遠端IP!"):"connect fail"===o.data[i]&&alert("與目標裝置連接失敗，請確認目標裝置的IP位址是否與遠端IP一致!"):e&&("wifi"===i?switchWifi(o.data[i]):e.innerHTML=o.data[i])}catch(e){console.error(e)}}function postCmd(e){""!==e&&(jsonCmd={SENDCMD:e},w.postMessage(jsonCmd))}function execCmd(e){editCmd=0,str=$(e).value,$(e).value="",0===str.indexOf("clear msg")?$("tx").value="":postCmd(str)}function formatData(e){var o=',"tx":',l=',"bps":',t=e.split(o)[0]+o,n=e.split(o)[1].split(l)[0].split("\\r\\n"),l=l+e.split(o)[1].split(l)[1],a="";for(let e=0;e<n.length;e++){const s=n[e];-1!=s.indexOf('{"')&&(a=s.substring(s.indexOf('{"')))}return t+a+l}function editSSID(){var e,o=prompt("請輸入SSID:");/^.{1,16}$/.test(o)?(e=prompt("請輸入8~16位密碼:"),/[0-9a-zA-Z]{8,16}$/.test(e)?confirm(`確定更改為 wifi名稱: ${o}, 密碼: ${e} ?`)&&postCmd(`@set SAP [${o}]:[${e}]`):alert("格式不符，請重試")):alert("格式不符，長度為1~16")}function showSYS(l){var e=l[1];if(e<<=8,!((e+=l[2])<4)){let o=0;for(let e=3;e<7;++e)o<<=8,o+=l[e];$("LT").innerHTML=o}}function showEEPROM(o){var l="\t";for(let e=0;e<16;++e)l+=e<16?"x":"",l+=e.toString(16),l+="\t";l+="\n";let t=3;for(let e=0;e<20;++e){l+=e<16?"0":"",l+=e.toString(16),l+="x",l+="\t";for(let e=0;e<16;++e){var n=o[t++];l+=n<16?"0":"",l+=n.toString(16),l+="\t"}l+="\n"}$("tx").value=l}function showUserData(e){showADC(DATA=data2json(e)),showPWM(DATA)}function data2json(o){let e={},l=[],t=[],n=[];for(let e=0;e<16;e++){var a=o[2*e+3];a<<=8,a+=o[2*e+4],l.push(a)}e.adc=l;for(let e=0;e<8;e++){var s=o[e+35];t.push(s)}e.servo=t;for(let e=0;e<8;e++){var i=o[e+43];n.push(i)}return e.pwm=n,e}function createClearAllTimeouts(){const o=()=>{};let l=setTimeout(o,0);return()=>{for(var e=setTimeout(o,0);l!==e;)l+=1,clearTimeout(l)}}function createClearAllIntervals(){const o=()=>{};let l=setInterval(o,0);return()=>{for(var e=setInterval(o,0);l!==e;)l+=1,clearInterval(l)}}console.oldLog=console.log,console.log=function(e){return console.oldLog(e),$("loop-result").value+=`${e}\r\n`,$("loop-result").scrollTop=$("loop-result").scrollHeight,e},$("WSSCMD").addEventListener("keyup",e=>{"Enter"===e.key&&(e.preventDefault(),execCmd("WSSCMD"))});const clearAllTimeouts=createClearAllTimeouts(),ClearAllIntervals=createClearAllIntervals();window.is_loop_enable=!1;var loop_count=1;const newLoop=async()=>{const delay=o=>new Promise(function(e){setTimeout(e,o)});if(swCode&&count_elements<1)alert("程式區塊不可為空值");else if(swCode||$("loop-tx").value){if(1===loop_count){let arr="";arr=(swCode?AllBlock2js():$("loop-tx").value).split("\n");let result=[];for(let i=0;i<arr.length;i++){const str=arr[i];-1!=str.indexOf("window")&&result.push(arr[i])}eval(result.join("")),$("loop-result").value=""}let time=300;if(!is_loop_enable)try{let arr_eval="";is_loop_enable=!0,clearAllTimeouts(),console.log(`\r\n<-----迴圈執行---第${loop_count}次----->\r\n`),$("loop-result").style.backgroundColor="#56ff2ca4",arr_eval=(swCode?AllBlock2js():$("loop-tx").value).split("\n");for(let i=0;i<arr_eval.length;i++){const str=arr_eval[i];-1!=str.indexOf("delay(")&&(arr_eval[i]=`await ${arr_eval[i]}`)}for(;-1!=arr_eval.join().indexOf("window");)for(let i=0;i<arr_eval.length;i++){const str=arr_eval[i];-1!=str.indexOf("window")&&arr_eval.splice(i,1)}await eval("(async () => {"+arr_eval.join("")+"\nis_loop_enable=false;})()"),loop_count+=1}catch(error){return clearAllTimeouts(),is_loop_enable=!1,$("loop-result").style.backgroundColor="#ff1f1fa4",console.log(error),void init_drag()}await delay(time),newLoop()}else alert("程式區塊不可為空值")};function StopLoop(){$("loop-result").value+="停止迴圈\r\n",is_loop_enable=!1,loop_count=1,clearAllTimeouts(),init_drag()}function clearLog(){$("loop-result").value="",$("loop-result").style=""}function clearAll(){confirm("是否清除區塊內所有程式(會覆蓋這個存檔) ?")&&(StopLoop(),$("loop-result").value="",$("loop-result").style="",swCode?readBlock("init_block"):$("loop-tx").value="")}function addDelay(){$("loop-tx").value+="\r\ndelay(1000);",$("loop-tx").scrollTop=$("loop-tx").scrollHeight}function addLog(){$("loop-tx").value+='\r\nconsole.log("顯示輸入資料結果");',$("loop-tx").scrollTop=$("loop-tx").scrollHeight}function addForloop(){$("loop-tx").value+=`\r\nvar array=[1,2,3,4,5];\r\nfor (let i = 0; i < array.length; i++) {
  let element = array[i];
  console.log(element);
}`,$("loop-tx").scrollTop=$("loop-tx").scrollHeight}function addIfElse(){$("loop-tx").value+=`\r\nif () {
    
} else if() {
    
} else {
    
}`,$("loop-tx").scrollTop=$("loop-tx").scrollHeight}function loop_select_add(e){switch(e){case 1:addDelay(1);break;case 2:addLog(1);break;case 3:addIfElse(1);break;case 4:addForloop(1)}localStorage.getItem("loop_code_name")&&localStorage.setItem(`loop_code_save_${localStorage.getItem("loop_code_name")}`,$("loop-tx").value)}function block_refact_localstorage(){var o=[];for(const e in localStorage)Object.hasOwnProperty.call(localStorage,e)&&e.includes("block_code_save")&&o.push(e);o=o.sort();for(let e=0;e<o.length;e++){var l=localStorage.getItem(o[e]);localStorage.removeItem(o[e]);var t=e+1<10?`0${e+1}`:`${e+1}`;o[e]=`${o[e].substring(0,16)}${t}:${o[e].substring(19)}`,localStorage.setItem(o[e],l)}init_block_code()}function block_select_code(e){var o=$("block-selectCode").options;if(e!==o.length-2)if(e!==o.length-1){o=o[e].text;if(localStorage.setItem("block_code_name",o),block_selectIndex=e,""===localStorage.getItem(`block_code_save_${o}`))return readBlock("init_block"),void($("loop-codeView-result").value=AllBlock2js());readBlock(`block_code_save_${o}`),$("loop-codeView-result").value=AllBlock2js()}else block_remove_code();else block_new_code()}function block_new_code(){var e=$("block-selectCode").options,o=e.length-2,l=prompt("請輸入名稱:","未命名");l?(readBlock("init_block"),l=o<10?`0${o}:${l}`:`${o}:${l}`,e.add(new Option(l,l),e[e.length-2]),localStorage.setItem(`block_code_save_${l}`,""),$("block-selectCode").selectedIndex=e.length-3,localStorage.setItem("block_code_name",l)):$("block-selectCode").selectedIndex=block_selectIndex}function block_remove_code(){var e=localStorage.getItem("block_code_name");if(!e)return alert("選擇存檔後才可刪除"),void($("block-selectCode").selectedIndex=0);confirm(`確定要刪除 ${e} ?`)?(localStorage.removeItem(`block_code_save_${e}`),block_refact_localstorage(),readBlock("init_block")):$("block-selectCode").selectedIndex=block_selectIndex}function init_block_code(){localStorage.setItem("block_code_name","");var e=$("block-selectCode"),o=e.options,l=document.createElement("option");e.innerHTML="",l.selected=!0,l.disabled="選擇方塊存檔",l.label="選擇方塊存檔",o.add(l),block_code_arr=[];for(const n in localStorage)Object.hasOwnProperty.call(localStorage,n)&&n.includes("block_code_save")&&block_code_arr.push(n.substring(16));block_code_arr=block_code_arr.sort();for(let e=0;e<block_code_arr.length;e++){var t=block_code_arr[e];o.add(new Option(t,t),o[o.length])}(l=document.createElement("option")).label="新增存檔",o.add(l),(l=document.createElement("option")).label="刪除存檔",o.add(l)}function loop_refact_localstorage(){var o=[];for(const e in localStorage)Object.hasOwnProperty.call(localStorage,e)&&e.includes("loop_code_save")&&o.push(e);o=o.sort();for(let e=0;e<o.length;e++){var l=localStorage.getItem(o[e]);localStorage.removeItem(o[e]);var t=e+1<10?`0${e+1}`:`${e+1}`;o[e]=`${o[e].substring(0,15)}${t}:${o[e].substring(18)}`,localStorage.setItem(o[e],l)}init_loop_code()}function loop_select_code(e){var o=$("loop-selectCode").options;e!==o.length-2?e!==o.length-1?(o=o[e].text,localStorage.setItem("loop_code_name",o),$("loop-tx").value=localStorage.getItem(`loop_code_save_${o}`),loop_selectIndex=e):loop_remove_code():loop_new_code()}function loop_new_code(){var e=$("loop-selectCode").options,o=e.length-2,l=prompt("請輸入名稱:","未命名");l?(l=o<10?`0${o}:${l}`:`${o}:${l}`,e.add(new Option(l,l),e[e.length-2]),localStorage.setItem(`loop_code_save_${l}`,""),$("loop-selectCode").selectedIndex=e.length-3,localStorage.setItem("loop_code_name",l),$("loop-tx").value=""):$("loop-selectCode").selectedIndex=loop_selectIndex}function loop_remove_code(){var e=localStorage.getItem("loop_code_name");if(!e)return alert("選擇存檔後才可刪除"),void($("loop-selectCode").selectedIndex=0);confirm(`確定要刪除 ${e} ?`)?(localStorage.removeItem(`loop_code_save_${e}`),loop_refact_localstorage(),$("loop-tx").value=""):$("loop-selectCode").selectedIndex=loop_selectIndex}function init_loop_code(){localStorage.setItem("loop_code_name","");var e=$("loop-selectCode"),o=e.options,l=document.createElement("option");e.innerHTML="",l.selected=!0,l.disabled="選擇JS存檔",l.label="選擇JS存檔",o.add(l),loop_code_arr=[];for(const n in localStorage)Object.hasOwnProperty.call(localStorage,n)&&n.includes("loop_code_save")&&loop_code_arr.push(n.substring(15));loop_code_arr=loop_code_arr.sort();for(let e=0;e<loop_code_arr.length;e++){var t=loop_code_arr[e];o.add(new Option(t,t),o[o.length])}(l=document.createElement("option")).label="新增存檔",o.add(l),(l=document.createElement("option")).label="刪除存檔",o.add(l)}function ExportConfig(){const e={};e.config={...localStorage};for(const n in e.config){var o;Object.hasOwnProperty.call(e.config,n)&&(o=e.config[n],e.config[n]=o)}var l=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),t=URL.createObjectURL(l),l=prompt("檔案命名","未命名");l?($("export").href=t,$("export").download=`${Date.now()}_${l}.json`):($("export").removeAttribute("href"),$("export").removeAttribute("download"))}function ImportConfig(){localStorage.clear(),init_loop_code();var t,n,a=$("upload").files[0],s=new FileReader;s.readAsText(a,"UTF-8"),s.onload=function(e){n=e.target.result,$("tx").value=`import: ${a.name}\n`,$("tx").value+=n;for(const l in t=JSON.parse(s.result).config){var o;Object.hasOwnProperty.call(t,l)&&(o=t[l],localStorage.setItem(l,o))}},$("upload").value="",window.location.reload()}function checkRemote(){"獨立模式"===$("wifi").innerText&&console.log("獨立模式無法進行遠端控制，請連上目標wifi!")}init_block_code(),$("loop-tx").addEventListener("input",e=>{e.preventDefault();e=localStorage.getItem("loop_code_name");e&&localStorage.setItem(`loop_code_save_${e}`,$("loop-tx").value)}),init_loop_code(),window.servo=[];for(let i=0;i<8;i++)servo[i]={set:e=>null===e?null:postCmd(`set RC${i+1} ${e}`)};window.pwm=[];for(let i=0;i<8;i++)pwm[i]={set:e=>null===e?null:postCmd(`set CH${i+1} ${e}`)};window.remote_cmd={set:e=>{checkRemote(),null!==e&&postCmd(`send CMD:${e}`)}};