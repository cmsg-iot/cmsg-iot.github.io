function $(e){return document.getElementById(e)}var w,scanHandler,res_wifi=void 0,swSys=!0,swTerm=!1,swWeb=!1,swMenu=!1,swZoom=!1,swCode=!1,swBlock=!1,swCV=!1,setup_selectIndex=0,loop_selectIndex=0,setup_code_arr=[],loop_code_arr=[],block_selectIndex=0,block_code_arr=[],DATA=null;function $(e){return document.getElementById(e)}function swCodeStyle(){swCode?($("loop-code").innerHTML="方塊程式",$("loop-block-area").style.display="none",$("loop-tx").style.display="block",$("loop-swBlock").style.display="none",$("loop-swBlock").style.backgroundColor="hotpink",$("loop-codeView").style.display="none",$("loop-swBlock").innerHTML="顯示方塊",$("loop-codeView").innerHTML="預覽關閉",$("index-source-container").style.display="none",$("loop-codeView-result").style.display="none",$("block-selectCode").style.display="none",$("loop-selectCode").style.display=""):($("loop-code").innerText="JS 程式",$("loop-block-area").style.display="block",$("loop-tx").style.display="none",$("loop-swBlock").style.display="initial",$("loop-codeView").style.display="initial",$("loop-swBlock").innerHTML="隱藏方塊",$("loop-codeView").innerHTML="方塊JS預覽",$("loop-codeView").style.backgroundColor="#cdffee",$("index-source-container").style.display="block",$("block-selectCode").style.display="initial",$("loop-selectCode").style.display="none",swCV=!(swBlock=!0)),swCode=!swCode}function swBlocks(){swBlock?($("loop-swBlock").innerHTML="顯示方塊",$("loop-swBlock").style.backgroundColor="#cdffee",$("index-source-container").style.display="none"):($("loop-swBlock").innerHTML="隱藏方塊",$("loop-swBlock").style.backgroundColor="hotpink",$("index-source-container").style.display="block"),swBlock=!swBlock}function swCodeView(){swCV?($("loop-codeView").innerHTML="方塊js預覽",$("loop-codeView").style.backgroundColor="#cdffee",$("loop-block-area").style.display="block",$("loop-codeView-result").style.display="none"):($("loop-codeView").innerHTML="預覽關閉",$("loop-codeView").style.backgroundColor="hotpink",$("loop-block-area").style.display="none",$("loop-codeView-result").style.display="initial",$("loop-codeView-result").value=AllBlock2js()),swCV=!swCV}function Zoom(){swZoom?($("loop-edit").classList.remove("zoom-in"),$("loop-zoom").innerHTML="展開",$("loop-zoom").style.backgroundColor="#cdffee",$("loop-result").style=""):($("loop-edit").classList.add("zoom-in"),$("loop-zoom").innerHTML="返回",$("loop-zoom").style.backgroundColor="hotpink",$("loop-result").style.display="none"),swZoom=!swZoom}function swSystem(){swSys?$("system").style.display="none":($("system").style.display="block",scroll({top:0,left:0,behavior:"smooth"})),swSys=!swSys}function swTerminal(){swTerm?($("terminal").style.display="none",$("loop").style.marginBottom="0px"):($("terminal").style.display="block",$("loop").style.marginBottom="450px"),swTerm=!swTerm}function swWebpage(){$("web").style.display=swWeb?"none":"block",swWeb=!swWeb}function swMenuBar(){swMenu?($("open-term").style.display="none",$("open-sys").style.display="none",$("open-web").style.display="none",$("open-export").style.display="none",$("open-upload").style.display="none",$("side-menu").children[0].innerHTML="選單"):($("open-term").style.display="block",$("open-sys").style.display="block",$("open-web").style.display="block",$("open-export").style.display="block",$("open-upload").style.display="block",$("side-menu").children[0].innerHTML="收起"),swMenu=!swMenu}function clearMsg(){$("tx").value=""}function showWifi(){$("mask-wifi").style="display: block;",$("wifi-content").style="display: block",document.body.style.overflow="hidden",scanWifi()}function scanWifi(){var o=0,l="",n=$("wifi-result"),a=$("wifi-refresh");res_wifi="",n.innerHTML="",postCmd("@AP scan"),a.disabled=!0;var e=document.createElement("div"),t=document.createElement("h3");t.innerHTML="搜尋中...",e.appendChild(t),n.appendChild(e),scanHandler=setInterval(()=>{return 10<=(o+=1)?(alert("已逾時，請重新搜尋。"),clearInterval(scanHandler),n.innerHTML="",void(a.disabled=!1)):void(res_wifi&&(l=res_wifi,$("wifi-now").innerHTML=$("wifi").innerText,n.innerHTML="",e=l.split("|"),t=document.createElement("li"),n.appendChild(t),e.forEach(e=>{var o;""!==e&&((o=document.createElement("input")).className="w-btn",o.type="button",o.value=e,o.onclick=()=>inputWifiPWD(e),t.appendChild(o))}),clearInterval(scanHandler),a.disabled=!1));var e,t},1e3)}function closeWifi(){$("wifi-content").style="display: none",$("mask-wifi").style="display: none",$("wifi-list").style="display: block",document.body.style.overflow="",clearInterval(scanHandler)}function inputWifiPWD(e){var o=prompt(`SSID: ${e},Wifi密碼: `);null!==o&&(postCmd(`@AP connect [${e}]:[${o}]`),$("wifi-content").style="display: none",$("mask-wifi").style="display: none",$("wifi-list").style="display: block")}function resetWifi(){postCmd("@AP connect reset")}function reconnectWifi(){postCmd("@AP connect reconnect")}function switchWifi(e){"standalone"===e?($("wifi").innerText="獨立模式",$("wifi-now").innerText="獨立模式",$("wifi-mode").onclick=reconnectWifi,$("wifi-mode").innerText="重新連接",$("wifi-mode").title="重新連接最後一次連上的wifi"):($("wifi").innerText=e,$("wifi-now").innerText=e,$("wifi-mode").onclick=resetWifi,$("wifi-mode").innerText="切斷連接",$("wifi-mode").title="切斷wifi連接，切換為獨立模式")}function openHelp(){$("mask-help").style.display="block",$("help-content").style.display="block"}function closeHelp(){$("mask-help").style.display="none",$("help-content").style.display="none"}function editDeviceName(e){postCmd(`@set Device ID: ${e}`)}function editBaud(e){postCmd(`@bps: ${e}`)}function editRemoteAddr(e){void 0!==e.split(":")[1]&&""!==e.split(":")[1]?postCmd(`set recv Addr ${e}`):postCmd(`set recv Addr ${e.split(":")[0]}:80`)}function getRemoteAddr(){postCmd("get recv Addr")}function getLocalIP(){postCmd(`send +ip REQ:ID:${$("device").innerText}`)}function connect(){"undefined"!=typeof Worker?(void 0===w&&((w=new Worker("./worker.js")).onmessage=wkMsg),cmd={URL:document.URL},w.postMessage(cmd)):console.log("not support Worker")}function wkMsg(o){try{if(o.data instanceof Uint8Array)return void(0===o.data[0]?showSYS(o.data):1===o.data[0]?showEEPROM(o.data):2===o.data[0]&&showUserData(o.data));var e;for(i in o.data)e=$(i),"tx"==i&&e?(e=$("tx"),str=e.value,str+="\n",str+=o.data[i],["ESP:set","ESP:SET"].some(e=>o.data[i].includes(e))&&alert("更換SSID成功，reset後生效"),"reconnected"===o.data[i]&&alert("已重新連上wifi!"),"reset"===o.data[i]&&alert("已切換至獨立模式!"),o.data[i].includes("set Device ID:")&&alert("已修改裝置名稱!"),o.data[i].includes("set Serial baudrate")&&alert("已修改裝置 UART Baud!"),o.data[i].includes("set correct baudrate")&&alert("請設定支援的Baud: 9600,19200,38400,74800,115200,230400"),o.data[i].includes("save")?(alert(`已設定遠端IP: ${o.data[i].split(" ")[1]}`),getRemoteAddr()):o.data[i].includes(":80")&&($("wifi-remote").innerText=`遠端IP ${o.data[i]}`),o.data[i].includes("file not exist")&&($("wifi-remote").innerText="遠端IP 未設定"),o.data[i].includes("IP:")&&($("wifi-local").innerText=`區網IP ${o.data[i].split(":")[1]}`),1e5<str.length&&(str=""),str.includes("|")&&(res_wifi=o.data.tx),e.value=str,e.scrollTop=e.scrollHeight):"content"===i?"no receive ip and port!!"===o.data[i]?alert("未設定遠端IP!"):"connect fail"===o.data[i]&&alert("與目標裝置連接失敗，請確認目標裝置的IP位址是否與遠端IP一致!"):e&&("wifi"===i?switchWifi(o.data[i]):e.innerHTML=o.data[i])}catch(e){console.error(e)}}function postCmd(e){""!==e&&(jsonCmd={SENDCMD:e},w.postMessage(jsonCmd))}function execCmd(e){editCmd=0,str=$(e).value,$(e).value="",0===str.indexOf("clear msg")?$("tx").value="":postCmd(str)}function formatData(e){var o=',"tx":',t=',"bps":',l=e.split(o)[0]+o,n=e.split(o)[1].split(t)[0].split("\\r\\n"),t=t+e.split(o)[1].split(t)[1],a="";for(let e=0;e<n.length;e++){const s=n[e];-1!=s.indexOf('{"')&&(a=s.substring(s.indexOf('{"')))}return l+a+t}function editSSID(){var e,o=prompt("請輸入SSID:");/^.{1,16}$/.test(o)?(e=prompt("請輸入8~16位密碼:"),/[0-9a-zA-Z]{8,16}$/.test(e)?confirm(`確定更改為 wifi名稱: ${o}, 密碼: ${e} ?`)&&postCmd(`@set SAP [${o}]:[${e}]`):alert("格式不符，請重試")):alert("格式不符，長度為1~16")}function showSYS(t){var e=t[1];if(e<<=8,!((e+=t[2])<4)){let o=0;for(let e=3;e<7;++e)o<<=8,o+=t[e];$("LT").innerHTML=o}}function showEEPROM(o){var t="\t";for(let e=0;e<16;++e)t+=e<16?"x":"",t+=e.toString(16),t+="\t";t+="\n";let l=3;for(let e=0;e<20;++e){t+=e<16?"0":"",t+=e.toString(16),t+="x",t+="\t";for(let e=0;e<16;++e){var n=o[l++];t+=n<16?"0":"",t+=n.toString(16),t+="\t"}t+="\n"}$("tx").value=t}function showUserData(e){showDataTable(DATA=data2json(e)),showCarColorDetect(),showCarMoveDir()}function showDataTable(e){for(const t in e){var o;Object.hasOwnProperty.call(e,t)&&(o=e[t],$(`${t}`).innerHTML=o)}}/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||swWebpage(),console.oldLog=console.log,console.log=function(e){return console.oldLog(e),$("loop-result").value+=`${e}\r\n`,$("loop-result").scrollTop=$("loop-result").scrollHeight,e},$("WSSCMD").addEventListener("keyup",e=>{"Enter"===e.key&&(e.preventDefault(),execCmd("WSSCMD"))});var newData={},show_color={};function data2json(o){let t=[],l=[];for(let e=0;e<4;e++){var n=o[2*e+3];n<<=8,n+=o[2*e+4],t.push(n)}newData.pingF=t[0],newData.pingL=t[1],newData.pingR=t[2],newData.pingB=t[3];for(let e=0;e<4;e++){var a=o[4*e+11],s=o[4*e+12],i=o[4*e+13],r=o[4*e+14];l.push([a,s,i,getColor(r).tag])}return newData.colorF=l[0],newData.colorB=l[1],newData.colorL=l[2],newData.colorR=l[3],3==o[35]&&(newData.dir=getDir(o[37]),newData.speed=[getSpeed(o[38]),getSpeed(o[39]),getSpeed(o[40]),getSpeed(o[41])]),newData}function getDir(e){switch(e){case 0:return"停止";case 1:return"向前";case 2:return"向後";case 3:return"向左";case 4:return"向右";case 5:return"左前";case 6:return"右前";case 7:return"左後";case 8:return"右後";case 9:return"逆轉";case 10:return"順轉";case 11:return"自由"}}function getColor(e){switch(e){case 1:return{tag:"紅",color:[255,0,0]};case 2:return{tag:"黃",color:[255,215,0]};case 4:return{tag:"粉紅",color:[255,150,200]};case 8:return{tag:"白",color:[255,255,255]};case 16:return{tag:"黑",color:[0,0,0]};case 32:return{tag:"綠",color:[0,255,0]};case 64:return{tag:"深藍",color:[0,0,255]};case 128:return{tag:"藍",color:[150,150,255]}}}function getSpeed(e){return e<128?-2*e:(127&e)<<1}function addDelay(){$("loop-tx").value+="\r\ndelay(1000);",$("loop-tx").scrollTop=$("loop-tx").scrollHeight}function addLog(){$("loop-tx").value+='\r\nconsole.log("顯示輸入資料結果");',$("loop-tx").scrollTop=$("loop-tx").scrollHeight}function addForloop(){$("loop-tx").value+=`\r\nvar array=[1,2,3,4,5];\r\nfor (let i = 0; i < array.length; i++) {
  let element = array[i];
  console.log(element);
}`,$("loop-tx").scrollTop=$("loop-tx").scrollHeight}function addIfElse(){$("loop-tx").value+=`\r\nif () {
    
} else if() {
    
} else {
    
}`,$("loop-tx").scrollTop=$("loop-tx").scrollHeight}function loop_select_add(e){switch(e){case 1:addDelay(1);break;case 2:addLog(1);break;case 3:addIfElse(1);break;case 4:addForloop(1)}localStorage.getItem("loop_code_name")&&localStorage.setItem(`loop_code_save_${localStorage.getItem("loop_code_name")}`,$("loop-tx").value)}function block_refact_localstorage(){var o=[];for(const e in localStorage)Object.hasOwnProperty.call(localStorage,e)&&e.includes("block_code_save")&&o.push(e);o=o.sort();for(let e=0;e<o.length;e++){var t=localStorage.getItem(o[e]);localStorage.removeItem(o[e]);var l=e+1<10?`0${e+1}`:`${e+1}`;o[e]=`${o[e].substring(0,16)}${l}:${o[e].substring(19)}`,localStorage.setItem(o[e],t)}init_block_code()}function block_select_code(e){var o=$("block-selectCode").options;if(e!==o.length-2)if(e!==o.length-1){o=o[e].text;if(localStorage.setItem("block_code_name",o),block_selectIndex=e,""===localStorage.getItem(`block_code_save_${o}`))return readBlock("init_block"),void($("loop-codeView-result").value=AllBlock2js());readBlock(`block_code_save_${o}`),$("loop-codeView-result").value=AllBlock2js()}else block_remove_code();else block_new_code()}function block_new_code(){var e=$("block-selectCode").options,o=e.length-2,t=prompt("請輸入名稱:","未命名");t?(readBlock("init_block"),t=o<10?`0${o}:${t}`:`${o}:${t}`,e.add(new Option(t,t),e[e.length-2]),localStorage.setItem(`block_code_save_${t}`,""),$("block-selectCode").selectedIndex=e.length-3,localStorage.setItem("block_code_name",t)):$("block-selectCode").selectedIndex=block_selectIndex}function block_remove_code(){var e=localStorage.getItem("block_code_name");if(!e)return alert("選擇存檔後才可刪除"),void($("block-selectCode").selectedIndex=0);confirm(`確定要刪除 ${e} ?`)?(localStorage.removeItem(`block_code_save_${e}`),block_refact_localstorage(),readBlock("init_block")):$("block-selectCode").selectedIndex=block_selectIndex}function init_block_code(){localStorage.setItem("block_code_name","");var e=$("block-selectCode"),o=e.options,t=document.createElement("option");e.innerHTML="",t.selected=!0,t.disabled="選擇方塊存檔",t.label="選擇方塊存檔",o.add(t),block_code_arr=[];for(const n in localStorage)Object.hasOwnProperty.call(localStorage,n)&&n.includes("block_code_save")&&block_code_arr.push(n.substring(16));block_code_arr=block_code_arr.sort();for(let e=0;e<block_code_arr.length;e++){var l=block_code_arr[e];o.add(new Option(l,l),o[o.length])}(t=document.createElement("option")).label="新增存檔",o.add(t),(t=document.createElement("option")).label="刪除存檔",o.add(t)}function loop_refact_localstorage(){var o=[];for(const e in localStorage)Object.hasOwnProperty.call(localStorage,e)&&e.includes("loop_code_save")&&o.push(e);o=o.sort();for(let e=0;e<o.length;e++){var t=localStorage.getItem(o[e]);localStorage.removeItem(o[e]);var l=e+1<10?`0${e+1}`:`${e+1}`;o[e]=`${o[e].substring(0,15)}${l}:${o[e].substring(18)}`,localStorage.setItem(o[e],t)}init_loop_code()}function loop_select_code(e){var o=$("loop-selectCode").options;e!==o.length-2?e!==o.length-1?(o=o[e].text,localStorage.setItem("loop_code_name",o),$("loop-tx").value=localStorage.getItem(`loop_code_save_${o}`),loop_selectIndex=e):loop_remove_code():loop_new_code()}function loop_new_code(){var e=$("loop-selectCode").options,o=e.length-2,t=prompt("請輸入名稱:","未命名");t?(t=o<10?`0${o}:${t}`:`${o}:${t}`,e.add(new Option(t,t),e[e.length-2]),localStorage.setItem(`loop_code_save_${t}`,""),$("loop-selectCode").selectedIndex=e.length-3,localStorage.setItem("loop_code_name",t),$("loop-tx").value=""):$("loop-selectCode").selectedIndex=loop_selectIndex}function loop_remove_code(){var e=localStorage.getItem("loop_code_name");if(!e)return alert("選擇存檔後才可刪除"),void($("loop-selectCode").selectedIndex=0);confirm(`確定要刪除 ${e} ?`)?(localStorage.removeItem(`loop_code_save_${e}`),loop_refact_localstorage(),$("loop-tx").value=""):$("loop-selectCode").selectedIndex=loop_selectIndex}function init_loop_code(){localStorage.setItem("loop_code_name","");var e=$("loop-selectCode"),o=e.options,t=document.createElement("option");e.innerHTML="",t.selected=!0,t.disabled="選擇JS存檔",t.label="選擇JS存檔",o.add(t),loop_code_arr=[];for(const n in localStorage)Object.hasOwnProperty.call(localStorage,n)&&n.includes("loop_code_save")&&loop_code_arr.push(n.substring(15));loop_code_arr=loop_code_arr.sort();for(let e=0;e<loop_code_arr.length;e++){var l=loop_code_arr[e];o.add(new Option(l,l),o[o.length])}(t=document.createElement("option")).label="新增存檔",o.add(t),(t=document.createElement("option")).label="刪除存檔",o.add(t)}function ExportConfig(){const e={};e.config={...localStorage};for(const n in e.config){var o;Object.hasOwnProperty.call(e.config,n)&&(o=e.config[n],e.config[n]=o)}var t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),l=URL.createObjectURL(t),t=prompt("檔案命名","未命名");t?($("export").href=l,$("export").download=`${Date.now()}_${t}.json`):($("export").removeAttribute("href"),$("export").removeAttribute("download"))}function ImportConfig(){localStorage.clear(),init_loop_code();var l,n,a=$("upload").files[0],s=new FileReader;s.readAsText(a,"UTF-8"),s.onload=function(e){n=e.target.result,$("tx").value=`import: ${a.name}\n`,$("tx").value+=n;for(const t in l=JSON.parse(s.result).config){var o;Object.hasOwnProperty.call(l,t)&&(o=l[t],localStorage.setItem(t,o))}},$("upload").value="",window.location.reload()}function checkRemote(){"獨立模式"===$("wifi").innerText&&console.log("獨立模式無法進行遠端控制，請連上目標wifi!")}init_block_code(),$("loop-tx").addEventListener("input",e=>{e.preventDefault();e=localStorage.getItem("loop_code_name");e&&localStorage.setItem(`loop_code_save_${e}`,$("loop-tx").value)}),init_loop_code(),window.move_stop={set:e=>postCmd("VM<00")},window.move_forward={set:e=>postCmd(null===e?"VM<0132":`VM<01${void 0===e?32:15<e?e.toString(16):"0"+e.toString(16)}`)},window.move_backward={set:e=>postCmd(null===e?"VM<0232":`VM<02${void 0===e?32:15<e?e.toString(16):"0"+e.toString(16)}`)},window.move_left={set:e=>postCmd(null===e?"VM<0332":`VM<03${void 0===e?32:15<e?e.toString(16):"0"+e.toString(16)}`)},window.move_right={set:e=>postCmd(null===e?"VM<0432":`VM<04${void 0===e?32:15<e?e.toString(16):"0"+e.toString(16)}`)},window.move_Lforward={set:e=>postCmd(null===e?"VM<0532":`VM<05${void 0===e?32:15<e?e.toString(16):"0"+e.toString(16)}`)},window.move_Rforward={set:e=>postCmd(null===e?"VM<0632":`VM<06${void 0===e?32:15<e?e.toString(16):"0"+e.toString(16)}`)},window.move_Lbackward={set:e=>postCmd(null===e?"VM<0732":`VM<07${void 0===e?32:15<e?e.toString(16):"0"+e.toString(16)}`)},window.move_Rbackward={set:e=>postCmd(null===e?"VM<0832":`VM<08${void 0===e?32:15<e?e.toString(16):"0"+e.toString(16)}`)},window.move_Lturn={set:e=>postCmd(null===e?"VM<0932":`VM<09${void 0===e?32:15<e?e.toString(16):"0"+e.toString(16)}`)},window.move_Rturn={set:e=>postCmd(null===e?"VM<1032":`VM<10${void 0===e?32:15<e?e.toString(16):"0"+e.toString(16)}`)},window.colorF={set:e=>{null!==e&&postCmd(`cb f ${e}`)}},window.colorB={set:e=>{null!==e&&postCmd(`cb b ${e}`)}},window.colorL={set:e=>{null!==e&&postCmd(`cb l ${e}`)}},window.colorR={set:e=>{null!==e&&postCmd(`cb r ${e}`)}},window.led_color={set:e=>{null!==e&&postCmd(`VM<${e}`)}},window.led_bright={set:e=>{null!==e&&postCmd(`VM<%${e}`)}},window.led_bright={set:e=>{null!==e&&postCmd(`VM<%${e}`)}},window.remote_servo=[];for(let o=0;o<8;o++)remote_servo[o]={set:e=>{checkRemote(),postCmd(`send CMD:set RC${o+1} ${e}`)}};window.remote_pwm=[];for(let o=0;o<8;o++)remote_pwm[o]={set:e=>{checkRemote(),null!==e&&postCmd(`send CMD:set CH${o+1} ${e}`)}};window.remote_cmd={set:e=>{checkRemote(),null!==e&&postCmd(`send CMD:${e}`)}};