var swTrash=!1,count_elements=0;let sourceContainerId="",dragElementId="",targetContainerId="",targetChildId="";for(let i=0;i<300;i++){let div=document.createElement("div");div.id=`target-container-${i+1}`,div.setAttribute("data-role","drag-drop-container"),div.className="container",$("target-containers").appendChild(div)}function init_drag(){let e=document.querySelectorAll('[draggable="true"]');e.forEach(e=>{e.addEventListener("dragstart",dragStart),e.addEventListener("dragend",dragEnd),e.addEventListener("click",e=>{e.stopPropagation()})});let t=0;for(let e=0;e<$("target-containers").children.length;e++)0<$(`target-container-${e+1}`).childElementCount&&(t+=1);count_elements=t,storeBlock()}function dragStart(e){e.stopPropagation(),vibration(),this.classList.add("dragging"),e.dataTransfer.setData("text/plain",e.target.id),sourceContainerId=this.parentElement.id,dragElementId=this.id,$(dragElementId).classList.remove("inside-if"),dragElementId.includes("index")||swTrashcan(!0)}function dragEnd(e){this.classList.remove("dragging"),swTrashcan(!1),init_drag()}localStorage.setItem("init_block",$("target-containers").innerHTML),init_drag();let dropTargets=document.querySelectorAll('[data-role="drag-drop-container"]');function dropped(e){if(init_drag(),""!=targetContainerId)if(targetContainerId!==sourceContainerId){if(!e.target.parentElement.id.includes("drag-copy")||"source-container"===sourceContainerId||""===sourceContainerId)return"trash-container"!==this.id&&"trash-container2"!==this.id||!dragElementId.includes("drag-source")&&!dragElementId.includes("index")?"trash-container"===this.id||"trash-container2"===this.id?(confirm("確定要丟棄方塊 ( ´•︵•` ) ?")&&$(dragElementId).remove(),void document.getElementById(targetContainerId).classList.remove("trash-ready")):checkVaildElement($(dragElementId),e.target)?void(dragElementId.includes("index")&&"source-container"!==targetContainerId?cloneBlock(e):"source-container"!==sourceContainerId||"source-container"===targetContainerId?this.id!==sourceContainerId&&"source-container"!==targetContainerId&&moveBlock(e):addBlock(e)):(e.target.classList.remove("hover"),void alert("這方塊不能放這裡 (´･ω･`) ")):(this.classList.remove("trash-ready"),void alert("you can't drop source element!"));exchangeBlock(e)}else e.path[0].classList.remove("hover");else e.target.classList.remove("hover")}function dragOver(e){cancelDefault(e),targetContainerId=this.id,targetChildId=e.path[1].id,"trash-container"===this.id||"trash-container2"===this.id?this.classList.add("trash-ready"):e.target.classList.add("hover")}function dragLeave(e){"trash-container"===this.id||"trash-container2"===this.id?this.classList.remove("trash-ready"):e.target.classList.remove("hover")}function cancelDefault(e){return e.preventDefault(),e.stopPropagation(),!1}function exchangeBlock(e){cancelDefault(e);let t=$(sourceContainerId),r=e.target.parentElement.parentElement;var l=$(e.target.parentElement.id),a=$(dragElementId);t.removeChild(a),r.removeChild(l),t.appendChild(l),r.appendChild(a),e.target.classList.remove("hover")}function moveBlock(t){cancelDefault(t);var r=t.dataTransfer.getData("text/plain");let e=$(dragElementId).className;if(t.target.className.split(" ")[0]!==$(r).className.split(" ")[0]){if(!(e.includes("var")||e.includes("val")||e.includes("op")||e.includes("bool")||e.includes("data"))||!t.target.id.includes("target-container")){if(!dragElementId.includes("control")&&!dragElementId.includes("setV")||"target-containers"===targetChildId)t.target.appendChild(document.querySelector("#"+r)),t.target.classList.remove("hover");else{let e=t.target.parentElement;e.style.height=`${50*(e.childElementCount+1)}px`,e.appendChild(document.querySelector("#"+r)),e.classList.remove("hover")}t.target.className.includes("block-area")&&($(r).classList.add("overlap"),t.target.classList.add("hidden"),t.path[1].childElementCount==t.target.getAttribute("data-index")&&addBlockArea(t.target,t.path[1]))}}else t.target.classList.remove("hover")}function cloneBlock(e){try{switch(dragElementId.split("-")[1]){case"data":addBlock(e,"drag-source-data");break;case"val":addBlock(e,"drag-source-val");break;case"var":addBlock(e,"drag-source-var");break;case"op":addBlock(e,"drag-source-op");break;case"bool":addBlock(e,"drag-source-bool");break;case"if":addBlock(e,"drag-source-if");break;case"setV":addBlock(e,"drag-source-setV");break;case"control":addBlock(e,"drag-source-control");break;case"log":addBlock(e,"drag-source-log");break;case"delay":addBlock(e,"drag-source-delay");break;default:alert("Not Vaild Block!")}}catch(e){console.error(e)}}function addBlock(r,e){cancelDefault(r);let t=e,l=document.createElement("div"),a=$(targetContainerId);if(l.id=e.substring(0,4)+"-copy-"+_uuid(),l.className=$(t).className,l.classList.remove("dragging"),l.draggable=!0,l.innerHTML=$(t).getInnerHTML(),r.target.className.split(" ")[0]!==$(t).className.split(" ")[0])if((t.includes("var")||t.includes("val")||t.includes("op")||t.includes("bool")||t.includes("data"))&&(r.path[0].id.includes("target-container")||r.target.className.includes("if")))a.classList.remove("hover");else{if((t.includes("control")||t.includes("setV")||t.includes("delay")||t.includes("log")||t.includes("if"))&&!r.target.id.includes("target-container"))if(t.includes("if"))a.appendChild(l),a.classList.remove("hover");else{let e=r.target.parentElement,t=r.path[1].children;e.appendChild(l),e.children[0].classList.remove("hover");for(let e=1;e<t.length;e++)t[e].classList.add("inside-if")}else r.target.appendChild(l),r.target.classList.remove("hover");let e=$(dragElementId).className.split("-")[0];(r.target.className.includes("block-area")&&"bool"===e||"op"===e||e.includes("v")||e.includes("data"))&&($(l.id).classList.add("overlap"),r.target.classList.add("hidden"),r.path[1].childElementCount==r.target.getAttribute("data-index")&&addBlockArea(r.target,r.path[1]),"if"===r.path[2].className.split("-")[0]&&(r.path[2].style.height=`${(r.path[1].childElementCount+1)/2*80}px`))}else r.target.classList.remove("hover")}function addBlockArea(e,t){let r=document.createElement("div");var l=parseInt(e.getAttribute("data-index"));r.setAttribute("data-role","drag-drop-container"),r.setAttribute("data-index",l+1),"bool"===e.className.split("-")[0]?(r.className="op-block-area",r.innerHTML="邏輯"):"op"===e.className.split("-")[0]&&(r.className="bool-block-area",r.innerHTML="判斷"),t.appendChild(r)}function checkVaildElement(e,t){if(null==e||null==t)return!1;let r=e.className.split("-")[0];e=t.className.split("-")[0];return(!dragElementId.includes("if")||"if"!==e)&&("if"===e&&"op"!==r&&"bool"!==r||(!!r.includes(e)||("data"===r&&"v"===e||(r===e||"container"==t.classList[0]))))}function block2js(a){try{var n=a.childElementCount;if("if"===a.className.split("-")[0]){let l=[],t=[];for(let e=0;e<n;e++){let r=a.children[e];var o=r.className.split("-")[0];if("if"===o)for(let e=0;e<r.childElementCount;e++){let t=r.children[e];if(!(t.childElementCount<1))if("bool"===t.className.split("-")[0]){let e=t.children[0].children[0];"data"===e.children[0].children[0].className.split("-")[0]&&"data"===e.children[2].children[0].className.split("-")[0]?l.push(`(${e.children[0].children[0].children[0].value} ${e.children[1].children[0].value} ${e.children[2].children[0].children[0].value})`):"data"!==e.children[0].children[0].className.split("-")[0]&&"data"===e.children[2].children[0].className.split("-")[0]?l.push(`(${e.children[0].children[0].children[0].innerText} ${e.children[1].children[0].value} ${e.children[2].children[0].children[0].value})`):"data"===e.children[0].children[0].className.split("-")[0]&&"data"!==e.children[2].children[0].className.split("-")[0]?l.push(`(${e.children[0].children[0].children[0].value} ${e.children[1].children[0].value} ${e.children[2].children[0].children[0].innerText})`):l.push(`(${e.children[0].children[0].children[0].innerText} ${e.children[1].children[0].value} ${e.children[2].children[0].children[0].innerText})`)}else"op"===t.className.split("-")[0]&&l.push(`${t.children[0].children[0].value}`)}else switch(o){case"log":"data"===r.children[0].children[0].children[0].className.split("-")[0]?t.push(`  console.log(${r.children[0].children[0].children[0].children[0].value});\n`):t.push(`  console.log(${r.children[0].children[0].children[0].children[0].innerText});\n`);break;case"control":void 0===r.children[0].children[1].children[0]?t.push(`  ${r.children[0].children[0].value}.set(null);\n`):"data"===r.children[0].children[1].children[0].className.split("-")[0]?t.push(`  ${r.children[0].children[0].value}.set(${r.children[0].children[1].children[0].children[0].value});\n`):t.push(`  ${r.children[0].children[0].value}.set(${r.children[0].children[1].children[0].children[0].innerText});\n`);break;case"setV":var i="全域"==r.children[0].innerText?"window.":"";"data"===r.children[0].children[2].children[0].className.split("-")[0]?t.push(`  ${i}${r.children[0].children[1].children[0].children[0].innerText} = ${r.children[0].children[2].children[0].children[0].value};\n`):t.push(`  ${i}${r.children[0].children[1].children[0].children[0].innerText} = ${r.children[0].children[2].children[0].children[0].innerText};\n`);break;case"delay":t.push(`  delay(${r.children[0].children[0].value});\n`)}}return`if(${l.join("")}){\n${t.join("")}}`}{let r=[];for(let t=0;t<n;t++){let e=a.children[t];switch(e.className.split("-")[0]){case"log":"data"===e.children[0].children[0].className.split("-")[0]?r.push(`console.log(${e.children[0].children[0].children[0].value});`):r.push(`console.log(${e.children[0].children[0].children[0].innerText});`);break;case"control":void 0===e.children[1].children[0]?r.push(`${e.children[0].value}.set(null);`):"data"===e.children[1].children[0].className.split("-")[0]?r.push(`${e.children[0].value}.set(${e.children[1].children[0].children[0].value});`):r.push(`${e.children[0].value}.set(${e.children[1].children[0].children[0].innerText});`);break;case"setV":var l="全域"==e.children[0].innerText?"window.":"";"data"===e.children[2].children[0].className.split("-")[0]?r.push(`${l}${e.children[1].children[0].children[0].innerText} = ${e.children[2].children[0].children[0].value};`):r.push(`${l}${e.children[1].children[0].children[0].innerText} = ${e.children[2].children[0].children[0].innerText};`);break;case"delay":r.push(`delay(${e.children[0].value});`)}}return r.join("")}}catch(e){throw e}}function AllBlock2js(){try{var r=$("target-containers"),l=r.children.length;let t=[];for(let e=0;e<l;e++)0<r.children[e].childElementCount&&t.push(`${block2js(r.children[e].children[0])}\n`);return t.join("")}catch(e){return console.error(e),void alert("格式錯誤，請檢查方塊所需變數是否已加入，變數是否已宣告 ( ꒪Д꒪)ノ")}}function storeBlock(){var e=$("target-containers").innerHTML,t=localStorage.getItem("block_code_name");t&&localStorage.setItem(`block_code_save_${t}`,e)}function readBlock(e){$("target-containers").innerHTML=localStorage.getItem(e);let t=document.querySelectorAll('[data-role="drag-drop-container"]');t.forEach(e=>{e.addEventListener("drop",dropped),e.addEventListener("dragenter",cancelDefault),e.addEventListener("dragover",dragOver),e.addEventListener("dragleave",dragLeave)});for(let e=0;e<$("target-containers").children.length;e++){var r=$(`target-container-${e+1}`).innerHTML;$(`target-container-${e+1}`).innerHTML=r}updateDragV(),updateInput(),updateSelect(),init_drag()}function updateDragV(){let e=document.querySelectorAll('[data-role="val-block"]'),t=document.querySelectorAll('[data-role="var-block"]');e.forEach(e=>{e.addEventListener("click",e=>{var t=prompt("輸入值 (^˵◕ω◕˵^) :",e.target.innerText);t.length<1?alert("格式錯誤，長度至少爲1，不可爲空白 ( ꒪Д꒪)ノ"):e.target.innerText=t,storeBlock()})}),t.forEach(e=>{e.addEventListener("click",e=>{var t=prompt("輸入變數名稱 (^˵◕ω◕˵^) :",e.target.innerText);t.length<1?alert("格式錯誤，長度至少爲1，不可爲空白 ( ꒪Д꒪)ノ"):e.target.innerText=t,storeBlock()})})}function updateInput(){let e=document.querySelectorAll("[data-type=input]");e.forEach(e=>{e.addEventListener("input",e=>{e.target.setAttribute("value",e.target.value),storeBlock()})})}function updateSelect(){let e=document.querySelectorAll("[data-type=select]");e.forEach(e=>{e.selectedIndex=e.getAttribute("select-index"),e.addEventListener("click",e=>{e.target.setAttribute("select-index",e.target.selectedIndex),storeBlock()})})}function updateVar(e){var t=confirm("是否爲全域變數?");e.children[0].innerText=t?"全域":"",storeBlock()}function setDataBlock(){let e=$("drag-source-data").children[0],t=document.createElement("option");t.value="DATA.dir",t.label="方向",e.appendChild(t),t=document.createElement("option"),t.value="DATA.speed",t.label="速度",e.appendChild(t),t=document.createElement("option"),t.value="DATA.pingF",t.label="超音波(前)",e.appendChild(t),t=document.createElement("option"),t.value="DATA.pingB",t.label="超音波(後)",e.appendChild(t),t=document.createElement("option"),t.value="DATA.pingL",t.label="超音波(左)",e.appendChild(t),t=document.createElement("option"),t.value="DATA.pingR",t.label="超音波(右)",e.appendChild(t),t=document.createElement("option"),t.value="DATA.colorF",t.label="顏色(前)",e.appendChild(t),t=document.createElement("option"),t.value="DATA.colorB",t.label="顏色(後)",e.appendChild(t),t=document.createElement("option"),t.value="DATA.colorL",t.label="顏色(左)",e.appendChild(t),t=document.createElement("option"),t.value="DATA.colorR",t.label="顏色(右)",e.appendChild(t)}function swTrashcan(e){e?($("trash-container").style.display="block",$("trash-container2").style.display="block"):($("trash-container").style.display="none",$("trash-container2").style.display="none")}function _uuid(){var r=Date.now();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(r+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(r+16*Math.random())%16|0;return r=Math.floor(r/16),("x"===e?t:3&t|8).toString(16)})}function showCarColorDetect(){try{$("color-forward").style.backgroundColor=`rgb(${DATA.colorF[0]}, ${DATA.colorF[1]},${DATA.colorF[2]})`,$("color-backward").style.backgroundColor=`rgb(${DATA.colorB[0]}, ${DATA.colorB[1]},${DATA.colorB[2]})`,$("color-left").style.backgroundColor=`rgb(${DATA.colorL[0]}, ${DATA.colorL[1]},${DATA.colorL[2]})`,$("color-right").style.backgroundColor=`rgb(${DATA.colorR[0]}, ${DATA.colorR[1]},${DATA.colorR[2]})`}catch(e){return}}function showCarMoveDir(){let e=$("web-car-sensor").rows[0].cells[0].children[0].classList,t=$("web-car-sensor").rows[0].cells[1].children[0].classList,r=$("web-car-sensor").rows[0].cells[2].children[0].classList,l=$("web-car-sensor").rows[1].cells[0].children[0].classList,a=$("web-car-sensor").rows[1].cells[2].children[0].classList,n=$("web-car-sensor").rows[2].cells[0].children[0].classList,o=$("web-car-sensor").rows[2].cells[1].children[0].classList,i=$("web-car-sensor").rows[2].cells[2].children[0].classList;var d=$("web-car-sensor").getElementsByTagName("div");for(let e=0;e<d.length;e++){const c=d[e];c.classList.remove("arrow-show")}try{switch(DATA.dir){case"左前":e.add("arrow-show");break;case"向前":t.add("arrow-show");break;case"右前":r.add("arrow-show");break;case"向左":l.add("arrow-show");break;case"向右":a.add("arrow-show");break;case"左後":n.add("arrow-show");break;case"向後":o.add("arrow-show");break;case"右後":i.add("arrow-show")}}catch(e){return}}function Car_speed(){return parseInt($("move-sp").value).toString(16)}function Car_control(){try{let e=move_temp.substring(0,2),t=move_temp.substring(2,4);postCmd(`VM<${e}${t}`),setInterval(()=>{e=move_temp.substring(0,2),t=move_temp.substring(2,4),postCmd(`VM<${e}${t}`)},1e3),setInterval(()=>{"0000"==move_temp&&(postCmd("VM<00"),clearAllInterval())},300)}catch(e){console.log(e)}}dropTargets.forEach(e=>{e.addEventListener("drop",dropped),e.addEventListener("dragenter",cancelDefault),e.addEventListener("dragover",dragOver),e.addEventListener("dragleave",dragLeave)}),setDataBlock(),window.CAR={stop:()=>postCmd("VM<00"),sp:(e,t,r,l)=>postCmd(`VM<sp ${255<e||e<-255?510:e+510} ${255<t||t<-255?510:t+510} ${255<r||r<-255?510:r+510} ${255<l||l<-255?510:l+510} `),forward:e=>postCmd(`VM<01${null==e?"00":15<e?e.toString(16):"0"+e.toString(16)}`),backward:e=>postCmd(`VM<02${null==e?"00":15<e?e.toString(16):"0"+e.toString(16)}`),left:e=>postCmd(`VM<03${null==e?"00":15<e?e.toString(16):"0"+e.toString(16)}`),right:e=>postCmd(`VM<04${null==e?"00":15<e?e.toString(16):"0"+e.toString(16)}`),Lforward:e=>postCmd(`VM<05${null==e?"00":15<e?e.toString(16):"0"+e.toString(16)}`),Rforward:e=>postCmd(`VM<06${null==e?"00":15<e?e.toString(16):"0"+e.toString(16)}`),Lbackward:e=>postCmd(`VM<07${null==e?"00":15<e?e.toString(16):"0"+e.toString(16)}`),Rbackward:e=>postCmd(`VM<08${null==e?"00":15<e?e.toString(16):"0"+e.toString(16)}`),Lturn:e=>postCmd(`VM<09${null==e?"00":15<e?e.toString(16):"0"+e.toString(16)}`),Rturn:e=>postCmd(`VM<10${null==e?"00":15<e?e.toString(16):"0"+e.toString(16)}`),colorSetF:e=>postCmd(`VM<cb f ${e}`),colorSetB:e=>postCmd(`VM<cb b ${e}`),colorSetL:e=>postCmd(`VM<cb l ${e}`),colorSetR:e=>postCmd(`VM<cb r ${e}`)};var move_temp="";function createClearAllTimeouts(){const t=()=>{};let r=setTimeout(t,0);return()=>{for(var e=setTimeout(t,0);r!==e;)r+=1,clearTimeout(r)}}$("move-forward-L").addEventListener("pointerdown",()=>{clearAllInterval(),move_temp=`05${Car_speed()}`,Car_control()}),$("move-forward-L").addEventListener("pointerup",()=>{move_temp="0000"}),$("move-forward").addEventListener("pointerdown",()=>{clearAllInterval(),move_temp=`01${Car_speed()}`,Car_control()}),$("move-forward").addEventListener("pointerup",()=>{move_temp="0000"}),$("move-forward-R").addEventListener("pointerdown",()=>{clearAllInterval(),move_temp=`06${Car_speed()}`,Car_control()}),$("move-forward-R").addEventListener("pointerup",()=>{move_temp="0000"}),$("move-stop").addEventListener("pointerdown",()=>{clearAllInterval(),postCmd("VM<00")}),$("move-left").addEventListener("pointerdown",()=>{clearAllInterval(),move_temp=`03${Car_speed()}`,Car_control()}),$("move-left").addEventListener("pointerup",()=>{move_temp="0000"}),$("move-right").addEventListener("pointerdown",()=>{clearAllInterval(),move_temp=`04${Car_speed()}`,Car_control()}),$("move-right").addEventListener("pointerup",()=>{move_temp="0000"}),$("move-backward-L").addEventListener("pointerdown",()=>{clearAllInterval(),move_temp=`07${Car_speed()}`,Car_control()}),$("move-backward-L").addEventListener("pointerup",()=>{move_temp="0000"}),$("move-backward").addEventListener("pointerdown",()=>{clearAllInterval(),move_temp=`02${Car_speed()}`,Car_control()}),$("move-backward").addEventListener("pointerup",()=>{move_temp="0000"}),$("move-backward-R").addEventListener("pointerdown",()=>{clearAllInterval(),move_temp=`08${Car_speed()}`,Car_control()}),$("move-backward-R").addEventListener("pointerup",()=>{move_temp="0000"}),$("move-Lturn").addEventListener("pointerdown",()=>{clearAllInterval(),move_temp=`09${Car_speed()}`,Car_control()}),$("move-Lturn").addEventListener("pointerup",()=>{move_temp="0000"}),$("move-Rturn").addEventListener("pointerdown",()=>{clearAllInterval(),move_temp=`10${Car_speed()}`,Car_control()}),$("move-Rturn").addEventListener("pointerup",()=>{move_temp="0000"});var clearAllTimeouts=createClearAllTimeouts();function createClearAllInterval(){const t=()=>{};let r=setInterval(t,0);return()=>{for(var e=setInterval(t,0);r!==e;)r+=1,clearInterval(r)}}var clearAllInterval=createClearAllInterval();window.is_loop_enable=!1;var loop_count=1;const newLoop=async()=>{const delay=t=>new Promise(function(e){setTimeout(e,t)});if(swCode&&count_elements<1)alert("程式區塊不可為空值");else if(swCode||$("loop-tx").value){if(1===loop_count){let arr="";arr=(swCode?AllBlock2js():$("loop-tx").value).split("\n");let result=[];for(let i=0;i<arr.length;i++){const str=arr[i];-1!=str.indexOf("window")&&result.push(arr[i])}eval(result.join("")),$("loop-result").value=""}let time=300;if(!is_loop_enable)try{let arr_eval="";is_loop_enable=!0,clearAllTimeouts(),console.log(`\r\n<-----迴圈執行---第${loop_count}次----->\r\n`),$("loop-result").style.backgroundColor="#56ff2ca4",arr_eval=(swCode?AllBlock2js():$("loop-tx").value).split("\n");for(let i=0;i<arr_eval.length;i++){const str=arr_eval[i];-1!=str.indexOf("delay(")&&(arr_eval[i]=`await ${arr_eval[i]}`)}for(;-1!=arr_eval.join().indexOf("window");)for(let i=0;i<arr_eval.length;i++){const str=arr_eval[i];-1!=str.indexOf("window")&&arr_eval.splice(i,1)}await eval("(async () => {"+arr_eval.join("")+"\nis_loop_enable=false;})()"),loop_count+=1}catch(error){return clearAllTimeouts(),is_loop_enable=!1,$("loop-result").style.backgroundColor="#ff1f1fa4",console.log(error),void init_drag()}await delay(time),newLoop()}else alert("程式區塊不可為空值")};function StopLoop(){$("loop-result").value+="停止迴圈\r\n",is_loop_enable=!1,loop_count=1,clearAllTimeouts()}function clearLog(){$("loop-result").value="",$("loop-result").style=""}function clearAll(){confirm("是否清除區塊內所有程式(會覆蓋這個存檔)?")&&(StopLoop(),$("loop-result").value="",$("loop-result").style="",swCode?readBlock("init_block"):$("loop-tx").value="")}function vibration(){navigator.vibrate([100])}